<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>silence-Prototype v23-06-25</title>
  <!-- Sch√∂ne Webfonts via Google Fonts, optional -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(120deg, #1a1b22 60%, #523378 110%);
      color: #ede9ff;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
    }
    #container {
      width: 100%;
      max-width: 420px;
      padding: 2.5em 1em 3em 1em;
      margin: 0 auto;
      background: rgba(40,18,80,0.20);
      border-radius: 22px;
      margin-top: 2.5em;
      box-shadow: 0 12px 48px #110d2055;
      display: flex; flex-direction: column; align-items: stretch;
    }
    h1 {
      margin: 0 0 0.5em 0;
      font-weight: 600;
      font-size: 1.7em;
      letter-spacing: 0.08em;
      color: #ffc857;
      text-shadow: 0 3px 17px #45108444;
    }
    .version {
      color: #8459ef;
      font-size: 0.66em;
      font-weight: 400;
      letter-spacing: 0.09em;
      margin-left: .6em;
    }
    button, select, input[type=number], input[type=text] {
      font-family: inherit;
      border-radius: 7px;
      border: none;
      outline: none;
      font-size: 1.09em;
      margin: .37em 0 .69em 0;
      padding: .57em 1.18em;
      background: #222042;
      color: #ffd993;
      transition: background .13s;
      box-shadow: 0 2px 13px #38208522 inset;
    }
    button:hover, select:hover {
      background: #392061;
      color: #fff;
    }
    button:active { background: #9147ff; color: #fff; }
    #langSelect {
      background: #11102e; 
      color: #ffa727;
      padding: .27em 1.15em;
      margin: 0;
      font-size: 1.09em;
      font-weight: 600;
      border: 1px solid #ffa50044;
    }
    #resetBtn {
      background: #ffc857;
      color: #54258d;
      font-weight: 700;
      margin-top: 1em;
      border: 1px solid #ff9147b0;
      padding: 0.6em 1.7em;
      box-shadow: 0 4px 15px #ff914760 inset;
    }
    #resetBtn:active { background: #ff9147; color: #fff; }
    #status { font-size: 1.19em; font-weight: 600; margin-bottom:0.5em;}
    .highlight { background: #ffa500bb; color: #54258d; font-size: 1.3em; padding: .44em 1.19em; border-radius: 0.8em;}
    .inputline label, .inputline input, .inputline select { display:inline-block; vertical-align:middle; }
    #result { min-height: 2.6em; padding: .7em 0 0 0; }
    #userID { color: #9147ff; background: #221c40; padding:.07em .5em; font-size:1.11em;}
    #transfer, #registration {
      background: rgba(20,14,35,0.27); border-radius: 10px; padding:1em 0.9em;
      box-shadow: 0 1px 10px #401c6622;
      margin-bottom: 2em;
    }
    .label-small {
      font-size: .97em; color: #d6c7ff;
      font-weight: 400; margin-right: .4em;
    }
    .silencebar {
      width:100%; height: 12px; border-radius: 8px; background: linear-gradient(80deg, #ffa500 40%, #9147ff 100%);
      opacity:.55; margin-top: 2.4em; margin-bottom: -1.5em;
    }
    .center { text-align: center; }
    @media (max-width: 499px) {
      #container { max-width:100vw; }
      h1 { font-size:1.1em;}
    }
  </style>
</head>
<body>
  <div class="silencebar"></div>
  <div id="container">
    <h1>silence-Prototype <span class="version">v23-06-25</span></h1>
    <div class="center" style="margin-bottom:1.5em;">
      <select id="langSelect">
        <option value="de-DE">Deutsch</option>
        <option value="en-US">English</option>
      </select>
    </div> 
    <div id="registration" class="center">
      <span class="label-small">Deine ID:</span>
      <span id="userID" style="font-family: monospace;"></span>
      <button id="registerBtn">Neue ID registrieren</button>
    </div>
    <div id="status" class="center"></div>
    <div class="center" style="margin-bottom:2em;">
      <button id="start">üéôÔ∏è Start Listening</button>
      <button id="stop" disabled>‚èπ Stop</button>
    </div>
    <div id="result" class="center"></div>

    <div id="transfer" class="center" style="margin-top:1em;">
      <h3 style="color:#ffa500;font-size:1.25em;margin-bottom:.1em;">Wort-Transfer</h3>
      <div class="inputline">
        <label class="label-small">Empf√§nger-ID: 
          <input id="toID" type="text" size="13" style="width:7em;font-size:1.08em;">
        </label>
        <label class="label-small">Menge: 
          <input id="amount" type="number" min="1" value="1" style="width:3.8em;">
        </label>
      </div>
      <button id="giveBtn">Transfer</button>
      <div id="transferMsg" style="font-size:0.99em"></div>
    </div>
    <div class="center" style="margin-top:2.7em">
      <button id="resetBtn" title="Reset f√ºr alle (admin code n√∂tig)">Admin Reset</button>
      <div id="resetMsg" style="color:#ffa500;font-size:0.93em;margin-top:.8em;"></div>
    </div>
  </div>

<script>
const SERVER = "https://DEIN-PYTHONANYWHERE-NAME.pythonanywhere.com"; // <-- Trage hier deine echte Server-URL ein!
let userID = localStorage.getItem("user_id") || null;
let currentLimit = 0;
let recognition = null;
let wakeLock = null;
let listening = false;
let selectedLang = localStorage.getItem("lang") || "de-DE";

document.getElementById("langSelect").value = selectedLang;
document.getElementById("langSelect").onchange = function() {
  selectedLang = this.value;
  localStorage.setItem("lang", selectedLang);
};

// Registrierung mit kurzer ID
async function registerUser() {
  const resp = await fetch(SERVER + "/api/register", {method: "POST"});
  const result = await resp.json();
  userID = result.user_id;
  localStorage.setItem("user_id", userID);
  document.getElementById('userID').textContent = userID;
  updateStatus();
}

async function updateStatus() {
  if (!userID) return;
  const resp = await fetch(SERVER + `/api/status?user_id=${userID}`);
  const result = await resp.json();
  if(result.limit !== undefined){
    currentLimit = result.limit;
    let msg = `Limit: <span style="color:#ffa500">${currentLimit}</span>`;
    if(currentLimit <= 0) {
      msg = `<span class="highlight">Limit erreicht!</span>`;
      document.body.style.background = "linear-gradient(120deg, #571a07 40%, #9147ff 110%)";
      stopListening();
    } else {
      document.body.style.background = "linear-gradient(120deg, #1a1b22 60%, #523378 110%)";
    }
    document.getElementById('status').innerHTML = msg;
  } else {
    document.getElementById('status').innerHTML = `<span style="color:#d44">${result.error||'Fehler'}</span>`;
  }
}

// W√∂rter verbrauchen: Abfrage beim Server
async function useWordsOnServer(count) {
  const resp = await fetch(SERVER + `/api/use_words`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: userID, amount: count })
  });
  const result = await resp.json();
  if(result.limit !== undefined) {
    currentLimit = result.limit;
    updateStatus();
    return true;
  } else {
    currentLimit = 0;
    updateStatus();
    document.getElementById('result').innerHTML += `<br><b style="color:#ffa500;">Limit erreicht!‚õî</b>`;
    return false;
  }
}

// Wort-Transfer
document.getElementById('giveBtn').onclick = async function() {
  let recipient = document.getElementById('toID').value.trim();
  let amount = +document.getElementById('amount').value;
  if (!recipient || !amount || amount < 1) {
    document.getElementById('transferMsg').textContent = "Bitte Ziel-ID und Menge korrekt angeben!";
    return;
  }
  const resp = await fetch(SERVER + "/api/transfer", {
    method: "POST",
    headers: { 'Content-Type': 'application/json'},
    body: JSON.stringify({sender_id:userID, recipient_id:recipient, amount})
  });
  const result = await resp.json();
  if(result.sender) {
    document.getElementById('transferMsg').textContent = "Transfer erfolgreich!";
    updateStatus();
  } else {
    document.getElementById('transferMsg').textContent = (result.error || "Transfer fehlgeschlagen");
  }
}

async function enableWakeLock() {
  if ('wakeLock' in navigator) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
    } catch (err) {/*noop*/}
  }
}

function stopListening() {
  if (recognition) recognition.stop();
  listening = false;
  document.getElementById('start').disabled = false;
  document.getElementById('stop').disabled = true;
}

function startListening() {
  if (listening) return;
  if (!userID) { alert('Bitte zuerst registrieren!'); return; }
  document.getElementById('result').innerHTML = "";
  updateStatus();
  enableWakeLock();
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert("Sorry, dein Browser unterst√ºtzt Spracherkennung nicht.");
      return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = selectedLang;
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.onresult = async (event) => {
      let transcript = event.results[event.resultIndex][0].transcript;
      let words = transcript.trim().split(/\s+/).filter(w => w.length > 0);
      let chunk = words.length;
      if(chunk < 1) return;
      const allowed = await useWordsOnServer(chunk);
      if(!allowed) {
        stopListening();
      } else {
        document.getElementById('result').innerHTML += `<br>+${chunk} W√∂rter`;
      }
  };
  recognition.onend = () => {
    // Mobil: Neustart, wenn Limit noch nicht erreicht
    if (listening && currentLimit > 0) {
      recognition.start();
    } else {
      stopListening();
    }
  };
  recognition.start();
  document.getElementById('start').disabled = true;
  document.getElementById('stop').disabled = false;
  listening = true;
}

// Registrierung
document.getElementById('registerBtn').onclick = registerUser;
if(userID) {
  document.getElementById('userID').textContent = userID;
  updateStatus();
}
// Start/Stop
document.getElementById('start').onclick = startListening;
document.getElementById('stop').onclick = stopListening;
// Status-Refresh
setInterval(updateStatus, 5000);

// Admin-Reset:
document.getElementById('resetBtn').onclick = async function() {
  let pwd = prompt("Admin-Code eingeben:");
  if(!pwd) return;
  const resp = await fetch(SERVER + "/api/reset", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({secret: pwd})
  });
  const result = await resp.json();
  if (result.status) {
      document.getElementById("resetMsg").innerHTML = "Alle Limits wurden zur√ºckgesetzt!";
      // UserID l√∂schen, UI zur√ºcksetzen
      localStorage.removeItem("user_id");
      document.getElementById("userID").textContent = "";
      setTimeout(()=>location.reload(), 800);
  } else {
      document.getElementById("resetMsg").innerHTML = result.error || "Reset fehlgeschlagen!";
  }
};
</script>
</body>
</html>
